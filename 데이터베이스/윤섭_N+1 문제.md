# N+1 ë¬¸ì œ

### **N+1 ë¬¸ì œë€?**

ì—°ê´€ ê´€ê³„ê°€ ì„¤ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ê²½ìš°ì— ì¡°íšŒëœ ë°ì´í„° ê°¯ìˆ˜(n) ë§Œí¼ ì—°ê´€ê´€ê³„ì˜ ì¡°íšŒ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ì—¬ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” í˜„ìƒ (ì¦‰ ì…€ë ‰ë¬¸ ì—„ì²­ë‚˜ê²Œ ë°œìƒ)

### **í˜„ìƒ ì¬í˜„(ì¢…ì† ê´€ê³„ê°€ ìˆì–´ì•¼í•¨)**

**DB êµ¬ì¡°ëŠ” ìœ ì €(USER)ëŠ” í•œê°œì˜ íŒ€(TEAM)ì—ë§Œ ì†í•  ìˆ˜ ìˆê³  íŒ€(TEAM) í•˜ë‚˜ëŠ” ì—¬ëŸ¬ ëª…ì˜ ìœ ì €(USER)ê°€ ê°€ì…í•  ìˆ˜ ìˆë‹¤. í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œëŠ” 4ê°œì˜ íŒ€ë‹¹ ìœ ì € 4ëª…ì”© ì´ 20ëª…ì˜ ìœ ì €ë¥¼ ì¶”ê°€í–ˆë‹¤.**

![Untitled](N+1%20%E1%84%86%E1%85%AE%E1%86%AB%E1%84%8C%E1%85%A6%202b12f35c7e464a2f873ad4e131cc8c89/Untitled.png)

## **Fetch ëª¨ë“œë¥¼ EAGER(ì¦‰ì‹œ ë¡œë”©)ìœ¼ë¡œ í•œ ê²½ìš°**

```java
@Entity
public class User {
Â Â Â Â @Id
Â Â Â Â @GeneratedValue
Â Â Â Â private long id;
Â Â Â Â private String firstName;
Â Â Â Â private String lastName;

Â Â Â Â @ManyToOne(fetch = FetchType.EAGER)// ì¦‰ì‹œ ë¡œë”©
Â Â Â Â @JoinColumn(name = "team_id", nullable = false)
Â Â Â Â private Team team;
}
```

```java
@Entity
public class Team {
Â Â Â Â @Id
Â Â Â Â @GeneratedValue
Â Â Â Â private long id;
Â Â Â Â private String name;

Â Â Â Â @OneToMany(fetch = FetchType.EAGER)
Â Â Â Â private List<User> users = new ArrayList<>();
}
```

JpaRepositoryë¥¼ extends í•œ Interface ê°ì²´ì¸ TeamRepositoryì—ì„œ findAllì„ í˜¸ì¶œì„ í•˜ë©´

JpaRepositoryë¥¼ extends í•œ Interface ê°ì²´ì¸ TeamRepositoryì—ì„œ findAllì„ í˜¸ì¶œì„ í•˜ë©´

```sql
teamRepository.findAll();
System.out.println("============== N+1 ì‹œì  í™•ì¸ìš© ===================");
```

N + 1 ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

```sql
Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?
============== N+1 ì‹œì  í™•ì¸ìš© ===================
```

## **Fetch ëª¨ë“œë¥¼ LAZY(ì§€ì—° ë¡œë”©)ìœ¼ë¡œ í•œ ê²½ìš°**

Teamê³¼ User Entity ê°ì²´ì—ì„œ Fetch ëª¨ë“œë§Œ LAZYë¡œ ë³€ê²½í•œ í›„ ë˜‘ê°™ì´ findAllì„ í˜¸ì¶œ í•˜ë©´

```java
teamRepository.findAll();
```

ì´ë²ˆì—ëŠ” N + 1 ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ê²ƒì²˜ëŸ¼ ë³´ì¸ë‹¤.

```java
Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_
```

í•˜ì§€ë§Œ ì•„ë˜ì™€ ê°™ì´ usersë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•˜ë©´ N+1ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.

```sql
List<Team> all = teamRepository.findAll();
System.out.println("============== N+1 ì‹œì  í™•ì¸ìš© ===================");
all.stream().forEach(team -> {
    team.getUsers().size();
});
```

```sql
Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_
============== N+1 ì‹œì  í™•ì¸ìš© ===================
Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?

Hibernate: select users0_.team_id as team_id1_1_0_, users0_.users_id as users_id2_1_0_, user1_.id as id1_2_1_, user1_.first_name as first_na2_2_1_, user1_.last_name as last_nam3_2_1_, user1_.team_id as team_id4_2_1_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id=?
```

**ì¦‰, ì§€ì—° ë¡œë”©ì—ì„œëŠ” N+1 ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ” ê²ƒì²˜ëŸ¼ ë³´ì˜€ì§€ë§Œ ë§‰ìƒ ê°ì²´ë¥¼ íƒìƒ‰í•˜ë ¤ê³  í•˜ë©´ N+1 ë¬¸ì œê°€ ë°œìƒë˜ì–´ N+1ë¬¸ì œê°€ ë°œìƒë˜ëŠ” ì‹œì ë§Œ ì¦‰ì‹œ ë¡œë”©ê³¼ ë‹¤ë¥¼ ë¿ì´ë‹¤.**

### **ë°œìƒ ì´ìœ **

N+1 ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ì´ìœ ëŠ” JPAê°€ JPQLì„ ë¶„ì„í•´ì„œ SQLì„ ìƒì„±í•  ë•ŒëŠ” ê¸€ë¡œë²Œ Fetch ì „ëµì„ ì°¸ê³ í•˜ì§€ ì•Šê³  ì˜¤ì§ JPQL ìì²´ë§Œì„ ì‚¬ìš©í•œë‹¤.
 ì¦‰, ì•„ë˜ì™€ ê°™ì€ ìˆœì„œë¡œ ë™ì‘í•œë‹¤.

**Fetch ì „ëµì´ ì¦‰ì‹œ ë¡œë”©ì¸ ê²½ìš°**
1. findAll()ì„ í•œ ìˆœê°„ select t from Team t ì´ë¼ëŠ” JPQL êµ¬ë¬¸ì´ ìƒì„±ë˜ê³  í•´ë‹¹ êµ¬ë¬¸ì„ ë¶„ì„í•œ select * from team ì´ë¼ëŠ” SQLì´ ìƒì„±ë˜ì–´ ì‹¤í–‰ëœë‹¤. ( SQL ë¡œê·¸ ì¤‘ Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_ ë¶€ë¶„ )
2. DBì˜ ê²°ê³¼ë¥¼ ë°›ì•„ team ì—”í‹°í‹°ì˜ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ìƒì„±í•œë‹¤.
3. teamê³¼ ì—°ê´€ë˜ì–´ ìˆëŠ” user ë„ ë¡œë”©ì„ í•´ì•¼ í•œë‹¤.
4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—°ê´€ëœ userê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
5. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ë‹¤ë©´ 2ì—ì„œ ë§Œë“¤ì–´ì§„ team ì¸ìŠ¤í„´ìŠ¤ë“¤ ê°œìˆ˜ì— ë§ê²Œ select * from user where team_id = ? ì´ë¼ëŠ” SQL êµ¬ë¬¸ì´ ìƒì„±ëœë‹¤. ( N+1 ë°œìƒ )

**Fetch ì „ëµì´ ì§€ì—° ë¡œë”©ì¸ ê²½ìš°**
1. findAll()ì„ í•œ ìˆœê°„ select t from Team t ì´ë¼ëŠ” JPQL êµ¬ë¬¸ì´ ìƒì„±ë˜ê³  í•´ë‹¹ êµ¬ë¬¸ì„ ë¶„ì„í•œ select * from team ì´ë¼ëŠ” SQLì´ ìƒì„±ë˜ì–´ ì‹¤í–‰ëœë‹¤. ( SQL ë¡œê·¸ ì¤‘ Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_ ë¶€ë¶„ )
2. DBì˜ ê²°ê³¼ë¥¼ ë°›ì•„ team ì—”í‹°í‹°ì˜ ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ìƒì„±í•œë‹¤.
3. ì½”ë“œ ì¤‘ì—ì„œ team ì˜ user ê°ì²´ë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•˜ëŠ” ì‹œì ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—°ê´€ëœ userê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤
4. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—†ë‹¤ë©´ 2ì—ì„œ ë§Œë“¤ì–´ì§„ team ì¸ìŠ¤í„´ìŠ¤ë“¤ ê°œìˆ˜ì— ë§ê²Œ select * from user where team_id = ? ì´ë¼ëŠ” SQL êµ¬ë¬¸ì´ ìƒì„±ëœë‹¤. ( N+1 ë°œìƒ )

### **í•´ê²° ë°©ë²•**

N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì—ëŠ” Fetch Join ,EntityGraphÂ **ì–´ë…¸í…Œì´ì…˜**Â , Batch Size ë“±ì˜ ë°©ë²•ì´ ìˆë‹¤.

**1. Fetch Join**

JPQLì„ ì‚¬ìš©í•˜ì—¬ DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ì²˜ìŒë¶€í„° ì—°ê´€ëœ ë°ì´í„°ê¹Œì§€ ê°™ì´ ê°€ì ¸ì˜¤ê²Œ í•˜ëŠ” ë°©ë²•ì´ë‹¤. (SQL Join ë¬¸ì„ ìƒê°í•˜ë©´ ëœë‹¤. )ë³„ë„ì˜ ë©”ì†Œë“œë¥¼ ë§Œë“¤ì–´ì¤˜ì•¼ í•˜ë©° @Query ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ "join fetch ì—”í‹°í‹°.ì—°ê´€ê´€ê³„_ì—”í‹°í‹°" êµ¬ë¬¸ì„ ë§Œë“¤ì–´ ì£¼ë©´ ëœë‹¤.

```java
public interface TeamRepository extends JpaRepository<Team, Long> {
Â Â Â Â @Query("select t from Team t join fetch t.users")
Â Â Â Â List<Team> findAllFetchJoin();
}
```

```sql
Â Â Â Â Â Â Â Â List<Team> all = teamRepository.findAllFetchJoin();
Â Â Â Â Â Â Â Â System.out.println("============== N+1 ì‹œì  í™•ì¸ìš© ===================");
Â Â Â Â Â Â Â Â all.stream().forEach(team -> {
Â Â Â Â Â Â Â Â Â Â Â Â team.getUsers().size();
Â Â Â Â Â Â Â Â });
```

```sql
Hibernate: select team0_.id as id1_0_0_, user2_.id as id1_2_1_, team0_.name as name2_0_0_, user2_.first_name as first_na2_2_1_, user2_.last_name as last_nam3_2_1_, user2_.team_id as team_id4_2_1_, users1_.team_id as team_id1_1_0__, users1_.users_id as users_id2_1_0__ from team team0_ inner join team_users users1_ on team0_.id=users1_.team_id inner join user user2_ on users1_.users_id=user2_.id
============== N+1 ì‹œì  í™•ì¸ìš© ===================
```

SQL ë¡œê·¸ë¥¼ ë³´ë©´ ë³„ë„ì˜ ì§€ì •ì„ ì•ˆí•˜ë©´ JPQLì—ì„œ join fetch êµ¬ë¬¸ì€ SQLë¬¸ì˜ inner join êµ¬ë¬¸ìœ¼ë¡œ ë³€ê²½ë˜ì–´ ì‹¤í–‰ëœë‹¤.

**2. EntityGraph ì–´ë…¸í…Œì´ì…˜**

@EntityGraph ë¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ fetch ì¡°ì¸ì„ í•˜ëŠ” ê²ƒì¸ë° ê·¸ëƒ¥ ì´ëŸ° ê²Œ ìˆêµ¬ë‚˜ë§Œ ì•Œì•„ë‘ê³  ì‚¬ìš©í•˜ì§€ ë§ì.ì‚¬ìš©í•˜ëŠ” ìˆœê°„ ì¡°ê¸ˆë§Œ ê´€ê³„ê°€ ë³µì¡í•´ì ¸ë„ í—¬ê²Œì´íŠ¸ê°€ ì—´ë¦°ë‹¤.

**3. Batch Size**

ì´ ì˜µì…˜ì€ ì •í™•íˆëŠ” N+1 ë¬¸ì œë¥¼ ì•ˆ ì¼ì–´ë‚˜ê²Œ í•˜ëŠ” ë°©ë²•ì€ ì•„ë‹ˆê³  N+1 ë¬¸ì œê°€ ë°œìƒí•˜ë”ë¼ë„ select * from user where team_id = ? ì´ ì•„ë‹Œ select * from user where team_id in (?, ?, ? ) ë°©ì‹ìœ¼ë¡œ N+1 ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ í•˜ëŠ” ë°©ë²•ì´ë‹¤.ì´ë ‡ê²Œ í•˜ë©´ 100ë²ˆ ì¼ì–´ë‚  N+1 ë¬¸ì œë¥¼ 1ë²ˆë§Œ ë” ì¡°íšŒí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì„±ëŠ¥ì„ ìµœì í™”í•  ìˆ˜ ìˆë‹¤.

application.yml

```sql
spring:
Â Â jpa:
Â Â Â Â properties:
Â Â Â Â Â Â hibernate:
Â Â Â Â Â Â Â Â default_batch_fetch_size: 1000
```

application.properties

```sql
spring.jpa.properties.hibernate.default_batch_fetch_size=1000
```

ê°„ë‹¨í•˜ê²Œ ì„¤ì • í•˜ë‚˜ ì„¸íŒ…í•´ì£¼ë©´ ì•„ë˜ì™€ ê°™ì´ in ì ˆë¡œ ì¿¼ë¦¬ê°€ ë‚˜ê°„ë‹¤.

```sql
Hibernate: select team0_.id as id1_0_, team0_.name as name2_0_ from team team0_
Hibernate: select users0_.team_id as team_id1_1_1_, users0_.users_id as users_id2_1_1_, user1_.id as id1_2_0_, user1_.first_name as first_na2_2_0_, user1_.last_name as last_nam3_2_0_, user1_.team_id as team_id4_2_0_ from team_users users0_ inner join user user1_ on users0_.users_id=user1_.id where users0_.team_id in (?, ?, ?, ?)
```

### **ì‹¤ë¬´ì—ì„œ N+1ë¬¸ì œë¡œ DBê°€ ì£½ì–´ë²„ë¦¬ëŠ” ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?**

ìš°ì„  ì—°ê´€ê´€ê³„ì— ëŒ€í•œ ì„¤ì •ì´ í•„ìš”í•˜ë‹¤ë©´ FetchTypeì„ ì„±ëŠ¥ ìµœì í™”ë¥¼ í•˜ê¸° ì–´ë ¤ìš´ ì¦‰ì‹œ ë¡œë”©(EAGER)ì„ ì‚¬ìš©í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ ì§€ì—° ë¡œë”© (LAZY) ëª¨ë“œë¡œ ì‚¬ìš©ì„ í•˜ê³  ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ë¶€ë¶„ì—ì„œëŠ” Fetch ì¡°ì¸ì„ ì‚¬ìš©í•œë‹¤.ë˜í•œ ê¸°ë³¸ì ìœ¼ë¡œ Batch Sizeì˜ ê°’ì„ 1000 ì´í•˜ë¡œ ì„¤ì •í•œë‹¤. (ëŒ€ë¶€ë¶„ì˜ DBì—ì„œ INì ˆì˜ ìµœëŒ€ ê°œìˆ˜ ê°’ : 1000)ê·¸ ì™¸ì— íŒ€ë°”íŒ€ì´ê¸´ í•œë° ê¼­ ì—°ê´€ê´€ê³„ ì„¤ì •ì´ í•„ìš” ì—†ë‹¤ë©´ N+1 ë¬¸ì œë¡œ ì¸í•˜ì—¬ DBê°€ ì£½ì–´ë²„ë¦¬ëŠ” ë¶ˆìƒì‚¬ë¥¼ ë§‰ê¸° ìœ„í•´ ì—°ê´€ê´€ê³„ë¥¼ ëŠì–´ë²„ë¦¬ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ë°©ë²•ì´ë‹¤.

<aside>
ğŸ’¡ ì´ê²ƒë§Œ ì•Œì•„ë‘ê¸°

N+1 ë¬¸ì œëŠ” ORMì—ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œë¡œ ì…€ë ‰ë¬¸ì´ ì—¬ëŸ¬ë²ˆ ì¼ì–´ë‚˜ëŠ” ë¬¸ì œë¥¼ ëœ»í•œë‹¤.

</aside>